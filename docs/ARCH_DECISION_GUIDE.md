# 멀티마켓 아키텍처 의사결정 가이드

## 목적
이 문서는 ROADMAP에서 식별된 4개 핵심 이슈를 다음 4가지 기준으로 평가하고,
실행 가능한 우선순위 해결 방향을 제시합니다.

평가 기준:
- 성능: 지연(latency), 처리량(throughput), 병목 여부
- 안정성: 데이터 정합성, 장애 복구 가능성, 운영 중 예측 가능성
- 학습곡선: 팀이 이해하고 유지보수하기까지의 난이도
- 복잡성: 구현량, 상태 관리 난이도, 디버깅 비용

---

## 기준별 해석

### 1. 성능
- 의미: 실시간 처리에서 이벤트 지연과 병목을 최소화하는 능력
- 확인 포인트:
  - 단일 락/단일 큐가 병목이 되는지
  - 마켓 수 증가(1 -> 5) 시 처리 지연이 선형으로 악화되는지
  - 복구/종료 시 대기 시간이 예측 가능한지
- 트레이드오프:
  - 성능 최적화는 종종 설계 복잡성을 증가시킴

### 2. 안정성
- 의미: 장애/재시작/중복 이벤트 상황에서도 자산·주문 상태가 틀어지지 않는 능력
- 확인 포인트:
  - 복구 시점 상태가 결정론적으로 수렴하는지
  - 중복/역순 이벤트를 허용해도 정합성이 유지되는지
  - DB/네트워크 장애 시 손실 없이 복구 가능한지
- 트레이드오프:
  - 안정성 강화 장치는 대기 시간과 구현량을 증가시킬 수 있음

### 3. 학습곡선
- 의미: 새 팀원이 구조를 이해하고 안전하게 수정 가능한 수준
- 확인 포인트:
  - 책임 경계가 명확한지
  - 런타임 상태 머신이 과도하게 얽혀 있지 않은지
  - 디버깅 시 추적 경로가 단순한지
- 트레이드오프:
  - 지나친 추상화는 오히려 학습 비용을 증가시킬 수 있음

### 4. 복잡성
- 의미: 실제 구현/운영/디버깅에 필요한 총 비용
- 확인 포인트:
  - 동시성 포인트 수(락, 큐, 스레드)가 관리 가능한지
  - 상태 전이 케이스가 폭발하지 않는지
  - 테스트가 현실적으로 작성/유지 가능한지
- 트레이드오프:
  - 복잡성 억제는 일부 고급 최적화를 지연시키는 선택이 될 수 있음

---

## 이슈별 권장 해법

## A. 복구 중 이벤트 경합
권장안:
- StartupRecovery + 최종 계좌 동기화가 끝날 때까지 WS 라우팅/마켓 워커 시작을 지연

기준 평가:
- 성능: 유리 (복구 중 불필요한 이벤트 처리 제거)
- 안정성: 매우 유리 (복구 상태를 결정론적으로 고정)
- 학습곡선: 유리 (플로우가 단순)
- 복잡성: 유리 (버퍼 재적용 로직 불필요)

비권장 1차안:
- 복구 중 이벤트 버퍼링 후 재적용
- 이유: 정합성은 높지만 구현/검증 복잡도가 급격히 상승

## B. SharedOrderApi 전역 직렬화 병목
권장안:
- 단일 전역 mutex를 즉시 폐기하지 말고, 우선순위 큐 + 레이트리밋(토큰 버킷)으로 단계적 개선
- 우선순위 예시: cancel/getOrder > submit/getOpenOrders/getMyAccount

기준 평가:
- 성능: 개선 (긴급 요청 대기시간 단축)
- 안정성: 개선 (레이트리밋 초과 및 폭주 제어)
- 학습곡선: 보통 (큐/우선순위 개념 추가)
- 복잡성: 보통 (연결풀 대비 낮음)

2단계(측정 후) 옵션:
- 다중 워커/연결풀
- 전제: 실제 병목 지표가 충분히 관측된 경우에만 도입

## C. 공유 OrderStore 격리 약화
권장안:
- 마켓별 로컬 OrderStore 분리
- 필요 시 얇은 전역 인덱스(order_id -> market)만 추가

기준 평가:
- 성능: 개선 (락 경합 감소)
- 안정성: 크게 개선 (마켓 간 장애 격리)
- 학습곡선: 보통 (구성은 단순, 접근 경로는 명확)
- 복잡성: 보통 (조회 경로 분리 필요)

비권장:
- 단일 공유 Store 유지 + 락 튜닝 반복
- 이유: 마켓 수 증가 시 디버깅 비용과 상호 간섭이 누적됨

## D. 장애형 게이트 부재
권장안:
- 기능 게이트 + 회복탄력 게이트 2층 구조
- 필수 장애 게이트 최소 세트:
  - 중복/역순 myOrder 이벤트
  - DB 지연/장애 + WAL 복구
  - REST 429/일시적 네트워크 단절
  - 재시작 직후 정합성(AccountManager/OrderStore/전략 상태)

기준 평가:
- 성능: 중립 (테스트 비용 증가)
- 안정성: 매우 유리 (운영 리스크 조기 발견)
- 학습곡선: 보통 (테스트 시나리오 문서화 필요)
- 복잡성: 보통 (테스트 파이프라인 분리 필요)

운영 팁:
- 짧은 필수 장애 테스트는 PR/CI에서 상시 실행
- 장시간 부하/soak 테스트는 야간 배치로 분리

---

## 권장 실행 순서
1. 복구 중 WS 라우팅 지연 시작(정합성 우선)
2. SharedOrderApi 우선순위 큐 + 레이트리밋
3. OrderStore 마켓별 분리
4. 회복탄력 게이트(장애형 테스트) 필수화

이 순서는 안정성을 먼저 확보하면서도, 성능 개선과 복잡성 증가를 단계적으로 관리하기 위한 우선순위입니다.
